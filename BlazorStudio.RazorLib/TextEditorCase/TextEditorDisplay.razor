@using BlazorStudio.ClassLib.TextEditor.IndexWrappers
@using System.Text
@using BlazorStudio.ClassLib.Keyboard
@using BlazorStudio.ClassLib.TextEditor.Enums
@using Microsoft.AspNetCore.Components.Web.Virtualization

@inherits Fluxor.Blazor.Web.Components.FluxorComponent

<ShouldRenderBoundary ShouldRenderFunc="ShouldRenderFunc">
    <button @onclick="ApplyRoslynSyntaxHighlightingAsyncOnClick"
            class="btn btn-primary">
        Apply Roslyn Syntax Highlighting
    </button>
    
    <div>
        <ExpansionDisplay TitleCssClass="bstudio_settings-section-title">
            <TitleRenderFragment>
                Edits&nbsp;Count:&nbsp;<em>@TextEditorStatesSelection.Value.EditBlocks.Length</em>
            </TitleRenderFragment>
            <BodyRenderFragment>
                <div style="overflow: auto; height: 5em;">
                    @{
                        var localTextEditorState = TextEditorStatesSelection.Value;

                        foreach (var editBlock in localTextEditorState.EditBlocks)
                        {
                            var message = editBlock.GetUserInterfaceDisplayMessage();
                            <div style="white-space: nowrap;">
                                @foreach (var character in message)
                                {
                                    if (character == '\t')
                                    {
                                        <text>&nbsp;&nbsp;&nbsp;&nbsp;</text>
                                    }
                                    else if (character == ' ')
                                    {
                                        <text>&nbsp;</text>
                                    }
                                    else
                                    {
                                        <text>@character</text>
                                    }
                                }
                            </div>
                        }
                    }
                </div>
            </BodyRenderFragment>
        </ExpansionDisplay>
    </div>

    <div class="pte_plain-text-editor-wrapping">
        <div class="pte_plain-text-editor-display"
             @onkeydown="HandleOnKeyDown"
             @onkeydown:preventDefault="true"
             @onclick="HandleOnClick">
            
            @{
                var localTextEditorState = TextEditorStatesSelection.Value;

                <Virtualize ItemsProvider="LoadTextCharacterSpans"
                            Context="textSpan"
                            @ref="_virtualize">
                    
                    <div style="white-space: nowrap;">
                        @{
                            var spanTextBuilder = new StringBuilder();
                            var currentDecorationByte = textSpan.TextCharacters
                                .First().DecorationByte;

                            foreach (var textCharacter in textSpan.TextCharacters)
                            {
                                if (currentDecorationByte == textCharacter.DecorationByte)
                                {
                                    if (textCharacter.Value == '\t')
                                    {
                                        // spanTextBuilder.Append("&nbsp;&nbsp;&nbsp;&nbsp;");
                                        spanTextBuilder.Append("~~~~");
                                    }
                                    else if (textCharacter.Value == ' ')
                                    {
                                        spanTextBuilder.Append("&nbsp;");
                                        // spanTextBuilder.Append("`");
                                    }
                                    else if (textCharacter.Value == '\r')
                                    {
                                        spanTextBuilder.Append('/');
                                    }
                                    else if (textCharacter.Value == '\n')
                                    {
                                        spanTextBuilder.Append('\\');
                                    }
                                    else
                                    {
                                        spanTextBuilder.Append(textCharacter.Value);
                                    }
                                }
                                else
                                {
                                    <span class="@DecorationKindHelper.ToDecorationKindCssStyleString(currentDecorationByte)">
                                        @((MarkupString)spanTextBuilder.ToString())
                                    </span>

                                    spanTextBuilder.Clear();

                                    currentDecorationByte = textCharacter.DecorationByte;
                                    spanTextBuilder.Append(textCharacter.Value);
                                }
                            }
                        }

                        @* Render out the last <span> *@
                        @if (spanTextBuilder.Length > 0)
                        {
                            <span class="@DecorationKindHelper.ToDecorationKindCssStyleString(currentDecorationByte)">
                                @((MarkupString)spanTextBuilder.ToString())
                            </span>
                        }
                    </div>
                </Virtualize>

                <TextEditorCursorDisplay @ref="_textEditorCursorDisplay"
                                         TextCursor="_cursor"
                                         TextEditorBase="localTextEditorState"/>
            }
        </div>
    </div>
</ShouldRenderBoundary>